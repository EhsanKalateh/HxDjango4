
{% extends "base.html" %}
{% load social_share %}
{% load crispy_forms_tags %}
{% load static %}
{% block title %} | {{case.title}}{%endblock title%}
{% block desc %}شرح حالی از {{ case.author.first_name }} {{ case.author.last_name }}{% endblock desc%}
{% block content %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<div class="pad-15">
{% if case.verified %}
{% comment %} <div class="article-entry" style='margin-left:50px; margin-right:50px'> {% endcomment %}
<h2 style="font-weight:600; padding-top:10px">{{ case.title }}</h2>
<p dir="ltr" style='margin-left:10px;'>
    <span style="color:#888" hidden>Share</span><button dir="rtl" onclick="copyToClipboard()" class="copyLink" id="copy"><img id="share"src="{% static 'images\share-icon.svg' %}" width="20px" alt="Copy case link to clipboard"></button>
    <br/> {{ case.date_created|date:"d M y" }}  &emsp; By {{ case.author.first_name }} {{ case.author.last_name }} | {{ case.author.degree }} 
</p>

<p style='margin-right:10px;'>
    {{ case.pretext|safe }}
</p>

<div class="paper">
    <h5 class='spanTwo' style="padding:15px 15px 0px 10px"> شرح حال و معاینۀ فیزیکی:</h5>
    <hr/ class="spanTwo" style="order=0">
    <div class="infoTable spanTwo">
        <div class="cell"> جنسیت: <b>{{ case.gender }}</b> </div> 
        <div class="cell"> وضعیت زناشویی: <b>{{ case.marriage }}</b> </div> 
        <div class="cell"> پیشه: <b>{{ case.job }}</b> </div>
        <div class="cell"> محل مراجعه: <b>{{ case.location }}</b> </div>
        <hr/ class="myHR" style="grid-column: span 5;">
        <div class="cell"><b>{{ case.age }}</b> ساله </div>
        <div class="cell">منبع شرح حال: <b>{{ case.source }}</b> </div>
        <div class="cell"> محل زندگی: <b>{{ case.dwelling }}</b> </div>
        <div class="cell"> میزان قابل اعتماد بودن: <b>{{ case.reliability }}</b>/5</div>
    </div>
    <div class="hx spanTwo"><b>CC: </b>{{ case.cc }}</div>

  <!---  {% if case.PR or case.BP_S or case.RR or case.Temp %}
        <div dir="ltr" class="vital">
        <div class="spanTwo vsText"><b>Vital Signs:</b></div>
        <div>PR: {{ case.PR }}</div>
        <div>BP: {{ case.BP_S }}/{{ case.BP_D }}</div>
        <div>RR: {{ case.RR }}</div>
        {% if case.SPO2_O %}
        <div>SP<sub>O&#8322;</sub>: {{ case.SPO2_O }}</div>
        {% endif %}
        <div>T: {{ case.Temp }}&#176;C</div>
        {% if case.SPO2_O %}
        <div>SP<sub>O&#8322;</sub><i>With</i> O&#8322;: {{ case.SPO2_N }}</div>
        {% endif %}
    </div>
    {% else %}
    <div dir="ltr" class="vital">
        <div class="spanTwo"><b>No Vital Sign Recorded</b></div>
    </div>
    {% endif %}-->
    <div class="hx"><b>PI: </b>{{ case.pi|linebreaks }}</div>

    <div class="hx"><b>PMH: </b>{{ case.pmh|linebreaks }}</div>
    {% if case.drg %}
    <div class="hx"><b>Drugs: </b>{{ case.drg|linebreaks }}</div>
    {% else %}
    <p style="margin:20px">بیمار دارو یا مادۀ ویژه‌ای مصرف <u>نمی‌کند</u>.</p>
    {% endif %}

    {% if case.sh %}
    <div class="hx"><b>SH: </b>{{ case.sh|linebreaks }}</div>
    {% else %}
    <p style="margin:20px">بیمار Social Historyای را ذکر <u>نمی‌کند</u>.</p>
    {% endif %}


    {% if case.alg %}
    <div class="hx"><b>Allergy: </b>{{ case.alg|linebreaks }}</div>
    {% else %}
    <p style="margin:20px">بیمار آلرژی‌ای را ذکر <u>نمی‌کند</u>.</p>
    {% endif %}

    {% if case.fh %}
    <div class="hx"><b>FH: </b>{{ case.fh|linebreaks }}</div>
    {% else %}
    <p style="margin:20px">بیمار Family Historyای را ذکر <u>نمی‌کند</u>.</p>
    {% endif %}

    <div class="hx"><b>Other Data: </b><br/>
        <div style="padding:5px;">
            {%if user.username == case.author.username %}
            <a href="add-image" style="color:#333;margin:5px; font-size:16px">
                تصاویر کیس خود را اضافه کنید.
            </a><br/>
            {%endif%}
            {%for img in case.imagecase_set.all %}
            {%if img.verified %}
            <img src="{{img.image.url}}" width="60" alt=""/>
            {% endif %}
            {% endfor%}
        </div>
        {%if case.imagecase_set.all %} <a href="#images" style="color:#333;margin:5px;">تمام تصاویر در زیر برگۀ شرح حال</a>{% endif %}<hr/>{{ case.dat|linebreaks }}
    </div>
    <div class="hx"><b>Review of Systems:</b> <br/>{{ case.ros|linebreaks}}</div>    
    <div class="hx"><b>Physical Examination:</b> <br/>{{ case.phe|linebreaks}}</div>
    <div class="hx" style="background-color:#ffd"><b>Summary: </b>{{ case.summary|linebreaks }}</div>
    {% comment %} <div class="hx"><br/>{{ case.ddx }}</div> {% endcomment %}
    <div class="hx">

        <details>
            <summary><b>Diffrential Dx:</b></summary>
        <p>{{ case.ddx|linebreaks}}</p>
        </details>
    </div>
    <div class="hx"><details><summary><b>Primary Dx:</b></summary>
        <p style="margin:10px">{{ case.pdx }}</p></details></div>
    <div class="hx"><b>Action:</b> <br/>{{ case.act|linebreaks }}</div>

</div>
<br/>
{% if case.imagecase_set.all|length > 0%}
<div class="paper">
    <h4 id="images" class="spanTwo">تصاویر</h4>
    <details class="spanTwo">
        <summary class="pad-15">کلیک کنید</summary>
        <div class="imageCaseCont">
        {%for img in case.imagecase_set.all %}
         {% comment %} {% if verified %} {% endcomment %}
            <div class="imageCaseCont">
                <img src="{{img.image.url}}" width="300" class="imageCaseImg" alt="{{case.title}}, {{img.type}}"/>
                <div>
                    <p dir="" class="imgType">{{img.type}}:</p>
                    <p class="imageCaseP">{{img.text}}</p>
                </div>
            </div>
            <hr class="spanTwo"/>
        {% endfor%}
        </div>
    </details>
</div>
{%else%}
<p style="color:#888"> <i>برای این کیس هنوز تصویری ثبت و تایید نشده است.</i></p>
{%endif%}
<div>
<p style='margin:20px 10px;'>
    {{ case.post_text|linebreaks }}
</p>
</div>
<p style="color:#888; text-align:center">با کلیک بر روی
<button dir="rtl" onclick="copyToClipboard()" class="copyLink"><img id="shareDown"src="{% static 'images\share-icon.svg' %}" width="20px" alt="Copy case link to clipboard"></button>
لینک مطلب را کپی کنید.
<span id="copied" hidden>(کپی شد!)</span>
</p>
{% comment %} {%if case.picasso%}
    <p>می‌توانید پیکاسو (تصویر کیس) مربوط به این شرح حال را در این <a href="{{case.picasso}}">لینک</a> مشاهده کنید.</p>
{%endif%} {% endcomment %}

{% comment %} <div class="social-sharing">
    <h3>Share this content:</h3>
    {% post_to_facebook object_or_url "Post to Facebook!" %}
    {% copy_to_clipboard case.slug "Copy to clipboard!" %}
</div> {% endcomment %}

{% comment %}{% if user.is_authenticated %}
 <hr/>
<div>
    <h4>دیدگاهی بیفزایید</h4>
    <form action="" method="post">{% csrf_token %}
    {{ form|crispy }}
    <button class="btn btn-success ml-2" type="submit">ثبت</button>
    </form>
    </div>
    <hr/>
    <div class="commentShow">
{%else%}
    <p>برای ثبت کامنت لازم است <a href="{% url "login" %}">وارد</a> شوید.</p>
{% endif %}
{% for comment in case.comment_set.all %}
{%if comment.verified %}
<div class="comment">
<span class="commentDetail">{{ comment.author }} در {{ comment.date_created|date:"d F" }} ساعت {{ comment.date_created|date:"H:i" }}:</span> 
<p style="margin:10px">&emsp;{{ comment }}</p>
</div>
    {%endif%}
    {% endfor %}
        </div>
</div> {% endcomment %}
<div>
    {% if user.is_authenticated %}
    <h4>دیدگاهی بیفزایید:</h4>
    <form method="post">
        {% csrf_token %}
        {{ comment_form|crispy }}
    <button class="btn btn-success ml-2" type="submit">ثبت</button>
    </form>
    </div>

{%else%}
<p style="margin:15px 7px">برای ثبت دیدگاه و پاسخ لازم است <b><a href="{% url "login" %}">وارد</a></b> شوید.</p>
{% endif %}
{% if comments.all.count > 0 %}    
<hr/>
    <h4 style="margin-bottom:15px">دیدگاه‌ها ({{comments.all | length}}):</h4>
{%endif%}
    {% for comment in comments|dictsort:"likes" reversed %}
    {%if comment.verified %}
    <div class="comment">
        <div class="comment-content">
            <span class="commentDetail">{{ comment.author }} در {{ comment.date_created|date:"d F" }} ساعت {{ comment.date_created|date:"H:i" }}:</span> 
            <p style="margin:10px">&emsp;{{ comment.comment }}</p>
        </div>
         <div class="like-section">
            <form dir="ltr" class="like-form" method="post" action="{% url 'like_comment' %}">
                {% csrf_token %}
                <input type="hidden" name="comment_id" value="{{ comment.id }}">
                <button type="submit" class="like-btn" style="{%if user in comment.liked_by.all %} color:#0b0 {%endif%}">&#9650;</button><span id="likes_count_{{ comment.id }}">{{ comment.likes }}</span>
            </form>
        </div>
    
    <div class="reply-box">
        {% if comment.reply_set.all.count > 0 %}
        <details class="reply">
            <summary>پاسخ‌ها ({{comment.reply_set.all | length}})</summary>
            <br/>
        {% for reply in comment.reply_set.all %}
            {% if reply.verified %}
            <div class="reply-each">
                <span class="commentDetail">{{ reply.author }} در {{ reply.date_created|date:"d F" }} ساعت {{ reply.date_created|date:"H:i" }}:</span> 
                <p class="reply-text">{{ reply.content }}</p>
            </div>
            {%endif%}
        {% endfor %}
        </details>
        {%else%}
        <p style="background-color:#fff; padding:5px; border-radius:5px; color:#666" hidden></p>
    {%endif%}
    {% if user.is_authenticated %}
    <form class="reply-form" id="reply_form_{{ comment.id }}" method="post" action="{% url 'add_reply' %}">
        {% csrf_token %}
        <input type="hidden" name="comment_id" value="{{ comment.id }}">
        <textarea name="reply_content" placeholder="پاسخ خود را اینجا بنویسید..." required></textarea>
        <button type="submit">ثبت</button>
    </form>
    
    {%endif%}
</div>
        {%endif%}


    </div>
        <!-- Display replies for the comment if any -->
        
    {% endfor %}
</div>
{% else %}
<h2>این مطلب هنوز به تایید ادمین نرسیده است.</h2>

{% endif %}
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const likeForms = document.querySelectorAll('.like-form');
        likeForms.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // If like request is successful, reload the page
                        window.location.reload();
                    } else {
                        console.error('Failed to like comment');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    });

    function copyToClipboard() {
        // Get the text field
        var copyText = "https://mdpt.ir/cases/hx/{{case.slug}}";
      
         // Copy the text inside the text field
        navigator.clipboard.writeText(copyText);
        var copied = document.getElementById("copied");
        copied.hidden=false;
        setTimeout(() => {
            copied.hidden=true;
          }, 4000);
      }
</script>
{% endblock content %}

{% block edit %}
{% if user.username == case.author.username %}
<a href="{% url 'hx_edit' case.slug %}" class="btn btn-warning" style="margin:1px; width:60px; font-size:16px; padding:0px; align-items:center">
    <span style="font-size:16px">ویرایش</span></a>
{% endif %}
{% endblock edit %}

{% block delete %}
{% if user.username == case.author.username %}
<a href="{% url 'hx_delete' case.slug %}" class="btn btn-danger" style="margin:1px; width:60px; font-size:16px; padding:0px;align-items:center">
    <span style="font-size:16px">حذف</span></a>
{% endif %}
{% endblock delete %}
