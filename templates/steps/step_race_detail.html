{% extends 'steps/steps_base.html' %}
{% load steps_tags %}
{% load static %}

{% block title %}{{ step.title }}{% endblock title %}

{% block imports %}
  <style>
    #xpBoxRace{
      display: none;
      background: linear-gradient(-60deg, #fff3fe, #fff9ff) padding-box, linear-gradient(to right, #16BFFD, #CB3066) border-box;
      border-radius: 13px 0;
      border: 2px solid transparent;
      padding: 0.5rem 1rem;
      margin: 1rem;
      text-align: center;
      box-shadow: 0 0 5px 2px #9932cc55;
  }
  </style>
{% endblock imports %}

{% block content %}
  <div class="progressDiv">
    <div class="progressBar">
      <div class="barShine"></div>
    </div>
  </div>
  <h1 style="margin:1rem" dir="ltr">Steps Race</h1>
  <h2 style="margin:1rem" dir="auto">{{ step.title }}</h2>
  <div dir="auto" style="font-size:12px; color:#666; margin:0 1.5rem">{{ step.description|linebreaksbr }}</div>


  {% for block in blocks %}
    <div 
    class="block-container {% if forloop.counter == 1 %}active{% endif %}" 
    id="block-{{ forloop.counter }}" 
    data-model="{{block|wModel}}" 
    data-xp="{{ block.xp }}"
    {% if block|isModel:"MonoTextCheckBlock" %}
      data-concept = "{{ block.concept.id }}"
      data-check-url="{% url 'mono_text_check' %}"
    {% endif %}
    >
      {% if block|isModel:"TextBlock" %}
        <div dir="auto" block.text|linebreaksbr }}</div>
      {% elif block|isModel:"ImageBlock" %}
      <div style="display: flex; justify-content: center; flex-direction: column; margin: 1rem;">
        <img src="{{ block.image.url }}" alt="{{ block.caption }}" style="max-width: 80%; margin: 1rem auto; border-radius: 10px;">
        <div id="explanation{{ forloop.counter }}" class="explanation" style="display:block" dir="auto"> {{ block.caption }} </div>
      </div>
      {% elif block|isModel:"MCQBlock" %}
        <div dir="auto">{{ block.question|linebreaksbr }}</div>
        <form id="mcq{{ forloop.counter }}">
          {% with choices=block.choices.items|shuffleDict %}
          <div class="MCQCont" dir="auto">
            {% for key, value in choices %}
              <label class="">
                <input type="radio" name="option" value="{{ key }}" class="hidden-radio">
                <span class="optionSpan">{{ value }}</span>
              </label>
            {% endfor %}
            </div>
          {% endwith %}
          <div class="checkBtnCont">
          <button type="button" id="checkMCQ{{forloop.counter}}" class="checkButton" data-clicked="0" onclick="checkMCQAnswer('{{ block.correct_choice }}', '{{ forloop.counter }}', '{{ block.xp }}')">Check Answer</button>
          </div>
          <div id="feedback{{ forloop.counter }}" class="feedback"></div>
          <div id="explanation{{ forloop.counter }}" class="explanation" dir=""><details><summary>پاسخ تشریحی</summary>{{block.explanation|sep_paraph}}</details></div>

        </form>


      {% elif block|isModel:"KeyFeatureBlock" %}
      <div dir="auto">{{ block.question|linebreaksbr }}</div>
        <div style="margin: 1rem;">
      <div dir="auto" class="feature-options" id="feature-options-{{ forloop.counter }}">
          <div class="features"></div>
          <div class="checkBtnCont">
              <button id="cB{{ forloop.counter }}" class="checkButton" data-clicked="0" onclick="checkKFAnswers({{ forloop.counter }}, {{block.xp}})">Check</button>
              <button id="rB{{ forloop.counter }}" class="checkButton resetBtn" onclick="resetKFSelection({{ forloop.counter }})">Reset Selection</button>

          </div>
          <div id="feedback{{ forloop.counter }}" class="feedback"></div>
          <div id="explanation{{ forloop.counter }}" class="explanation"><details><summary>پاسخ تشریحی</summary>{{block.explanation|sep_paraph}}</details></div>
      </div>
      </div>
      <script>
          document.addEventListener('DOMContentLoaded', function () {
              initFeatureBlock(
                  {{ forloop.counter }},
                  [ {% for feature in block.all_features.values %}"{{ feature }}"{% if not forloop.last %}, {% endif %}{% endfor %} ],
                  [ {% for feature in block.expected_features.values %}"{{ feature }}"{% if not forloop.last %}, {% endif %}{% endfor %} ],
                  {{ block.expected_features_count }}
              );
          });
      </script>
      

      {% elif block|isModel:"PairingBlock" %}
          <div dir="auto">{{ block.prompt|linebreaksbr }}</div>
          <div class="pairingDiv">
              <div class="key-container" dir="ltr">
                  {% for key, value in block.pairs.items %}
                      <span class="pairing-key" data-pair-id="{{ forloop.counter }}" dir="rtl">{{ key }}</span>
                  {% endfor %}
              </div>
      
              <div class="value-container">
                  {% for key, value in block.pairs.items %}
                      <span class="pairing-value" data-pair-id="{{ forloop.counter }}">{{ value }}</span>
                  {% endfor %}
              </div>
              
          </div>
          <div style="margin: 1rem">
              <div id="feedback{{ forloop.counter }}" class="feedback"></div>
              <div id="explanation{{ forloop.counter }}" class="explanation"><details><summary>پاسخ تشریحی</summary>{{block.explanation|sep_paraph}}</details></div>
          </div>
      {% elif block|isModel:"MonoTextCheckBlock" %}
      <style>
        .monoTextInput{
          padding: 5px 10px;
          border-radius: 10px;
          border: none;
          background-color: #eee;
          min-width: 100px;

        }
        .monoTextCheckBtn{
          border-radius: 10px;
          border: 1px solid #999;
          color: #333
        }
        .monoTextCheckBtn:disabled{
          opacity: 0.5
        }
        .monoTextResponse{
          background-color: #eee;
          border-radius: 10px;
          margin: 0.5rem 0;
          padding: 0.5rem;
          opacity:0; 
          transition:opacity .5s;
          display: none;
        }
        .monoTextStatusLight{
          width:12px;
          height: 12px;
          border-radius: 10px;
          background-color: #999;
          margin: auto;
          border: 1px solid #999;
        }
        .monoTextInputBtnCont{
          display: grid;
          grid-template-columns: 0.25fr 3fr 1fr;
          gap: 5px;
          margin: 1rem 0;
        }
        .monoTextExplanation{
          background-color: #eee;
          border-radius: 10px;
          padding: 0.5rem;
          display: none;
        }
      </style>
          <div dir="auto">{{ block.question|linebreaksbr }}</div>
          <!-- 2) Input -->
          <div class="monoTextInputBtnCont">
            <div class="monoTextStatusLight"></div>

            <input dir="auto" type="text" class="monoTextInput" placeholder="Type your answer…" autocomplete="off" />

            <!-- 3) Check button -->
            <button type="button" class="monoTextCheckBtn" data-concept="{{ block.answer_concept.id }}" data-xp="{{block.xp}}">Check</button>
          </div>

          <!-- 4) Response box (hidden by opacity) -->
          <div class="monoTextResponse" style="" aria-live="polite"></div>

          <!-- 5) Explanation box (hidden by opacity) -->
          <div dir="auto" class="monoTextExplanation" style="opacity:0; transition:opacity .5s;">
            {{ block.explanation|linebreaksbr }}
          </div>
      {% endif %}
      
    </div>

  {% endfor %}
<div style="display: flex">
  <button onclick="showNextBlock()" id="continue">بزن بریم</button>
</div>
<div id="xpBoxRace"></div>

  <form method="post" action="{% url 'submit_race_score' step.race.id %}" id="submitForm">
    {% csrf_token %}
    <input type="text" name="name" placeholder="Enter your name" id="enterName" required autocomplete="off" dir="auto" />
    <input type="hidden" name="score" id="scoreInput" value="" />
    <button type="submit" id="nameSubmit">Submit</button>
  </form>
    <div id="submitRespMessage" style="" dir="auto"></div>
    
    
<script src="{% static 'scripts/Steps/Pairing.js' %}"></script>
<script src="{% static 'scripts/Steps/KF.js' %}"></script>
<script src="{% static 'scripts/Steps/MCQ.js' %}"></script>
<script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get all check buttons
            const checkButtons = document.querySelectorAll('.monoTextCheckBtn');
            
            // Add click event listener to each button
            checkButtons.forEach(button => {
                button.addEventListener('click', handleCheckClick);
            });
            
            // Also allow Enter key to trigger the check
            const inputFields = document.querySelectorAll('.monoTextInput');
            inputFields.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const button = this.nextElementSibling;
                        if (button && button.classList.contains('monoTextCheckBtn')) {
                            handleCheckClick.call(button);
                        }
                    }
                });
            });
            
            // Handle the button click
            function handleCheckClick() {
                const button = this;
                const concept = button.getAttribute('data-concept');
                const xp = button.getAttribute('data-xp');
                const inputField = button.previousElementSibling;
                const statusLight = inputField.previousElementSibling;
                const responseElement = button.parentElement.nextElementSibling;
                const explanationElement = responseElement.nextElementSibling;
                
                // Get input value and trim whitespace
                const inputText = inputField.value.trim();
                
                // Validate input
                if (!inputText) {
                    responseElement.textContent = 'Please enter some text before checking.';
                    responseElement.style.display = 'block';
                    explanationElement.style.display = 'block';

                    responseElement.style.opacity = 1;
                    return;
                }
                
                // Disable button
                button.disabled = true;
                button.textContent = 'Checking...';
                const data = {
                  concept_id: concept,
                  input_text: inputText
                };
                // In a real implementation, this would be a fetch call to your Django backend
                    fetch("{% url 'mono_text_check' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken') // CSRF token for Django
                        },
                        body: JSON.stringify(data)
                      })
                    .then(response => response.json())
                    .then(data => {
                        // Update response element
                        responseElement.innerHTML = data.message;
                        responseElement.style.opacity = 1;
                        responseElement.style.color = data.color;
                        responseElement.style.backgroundColor = data.backColor;
                        statusLight.style.backgroundColor = data.backColor;
                        statusLight.style.borderColor = data.color;
                        responseElement.style.display = 'block';
                        
                        // Show explanation
                        explanationElement.style.display = 'block';
                        explanationElement.style.opacity = '1';
                        if (data.correct == 'true') {
                          totalXP += parseInt(xp)
                        };
                    })
                    .catch(error => {
                        responseElement.textContent = 'Error: ' + error;
                        responseElement.style.opacity = 1;
                    })
                    .finally(() => {
                        // Keep the button disabled permanently after response
                        button.textContent = 'Submitted';
                        enableContinue();
                    });
                  }
            
            function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                  const cookies = document.cookie.split(';');
                  for (let i = 0; i < cookies.length; i++) {
                      const cookie = cookies[i].trim();
                      if (cookie.substring(0, name.length + 1) === (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
          }
            
        });
    </script>

<script>
  let totalXP = 0;

document.addEventListener('DOMContentLoaded', function() {
  handlePairing();
});

</script>

<script>
  function showNextBlock() {
    const nextBlock = document.getElementById('block-' + (currentBlockIndex + 1));

    if (nextBlock) {
        nextBlock.classList.add('active');
        currentBlockIndex++;

        if (nextBlock.dataset.model === "textblock") {
            enableContinue();
        } else {
            disableContinue();
        }
        window.scrollBy({
            top: 500,
            behavior: 'smooth'
        });
    } else {
        disableContinue();
        const xpBox = document.getElementById("xpBoxRace");
        const scoreInput = document.getElementById("scoreInput")
        xpBox.style.display = 'block';
        if (totalXP > 0) {
            xpBox.textContent = `عالی بود. ${totalXP} امتیاز گرفتی! این پایین اسمت رو بنویس.`
            scoreInput.value = totalXP

        } else {
            xpBox.textContent = 'خوب بود. کلی چیز یاد گرفتی.'
            scoreInput.value = 0

        }
        window.scrollBy({
            top: 500,
            behavior: 'smooth'
        });
        document.getElementById("submitForm").style.display = "flex"
    }
}
</script>
<script>
function sendForm(event, title) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const submitRespMessage = document.getElementById('submitRespMessage');

    fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "ok") {
                window.location.href = data.redirect_url;
            } else {
                submitRespMessage.style.display = "block"
                submitRespMessage.innerHTML = data.message;
            }
        })
        .catch(data => {
            submitRespMessage.style.display = "block"
            submitRespMessage.innerHTML = "❌ Submission failed.";
        });
}
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("submitForm")
            .addEventListener("submit", e => sendForm(e, "Race Form"));
});
</script>
{% endblock content %}
