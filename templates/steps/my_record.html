{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ race.name }} – Rankings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% comment %} <meta http-equiv="refresh" content="10"> {% endcomment %}
    <link rel="stylesheet" href="{% static 'css/style_steps.css'%}">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400..800&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Baloo Bhaijaan 2'; 
      background: #f4f4f4;
      margin: 0;
      padding: 2rem;
      text-align: center;
    }

      h1 {
        color: #333;
        font-size: 1.5em;
      }
      .textBox{
        padding: 0.5rem 1rem;
        background-color: #d8d8d8;
        border-radius: 10px;
        max-width: 400px;
        text-align: center;
        margin: 1rem auto;
      }
      .btn{
        padding: 0.5rem 1rem;
        background-color: #d8d8d8;
        border-radius: 10px;
        box-shadow: 0 3px #666;
        color: #333;
        text-decoration: none;
        transition: 0.3s;
        display: inline-block;
        cursor: pointer;
      }
        
      .btn:hover{
        box-shadow: 0 0px #666;
      }
      #surveyTextArea{
        width: 90%;
        max-width: 400px;
        padding: 1rem;
        border-radius: 10px;
        font-size: 16px;
        margin-bottom: 1rem;
        margin-top: 0.5rem;
      }
      .form{
        padding: 1rem;
        display: flex;
        flex-direction: column;
        max-width: 400px;
        margin: 2rem auto;
        align-items: center;
        background-color: #f0f0f0;
        border-radius: 10px;
        text-align: right;
      }
      select{
        width: 60px;
        text-align: center;
        font-size: 16px;
        padding: 0.5rem;
        border-radius: 10px;
        margin-right: 0.25rem;
      }
      .realBtn{
        font-size: 18px;
        font-family: 'Baloo Bhaijaan 2';
        border: 1px solid #888;
        padding: 0.5rem 3rem;
        font-weight: 600;
      }
    </style>
  </head>
  <body dir="rtl">
    <h1>🏁 {{ race.name }} 🏁</h1>
    {% if score_matches %}
    <h2>Your Score: <span style="font-size:xxx-large">{{ record.score }}</span></h2>
        <p class=""></p>
    
        <div>
            <p class="textBox" style="display: inline-block; margin:0.5rem">
                رتبۀ شما از میان {{ total_records }} نفر: <b style="font-size:xx-large">{{ ranking }}  </b><span style="font-size:small">(تا به این لحظه)</span>
            </p>
            <span onclick="location.reload()" class="btn">⟳</span>
        </div>
        <p class="textBox">بالاترین نمره: <b style="font-size:xx-large">{{ highest_score }}</b></p>
        {% if same_score_records > 1 %}
            <p class="textBox">تعداد افراد با امتیاز مشابه شما: <b style="font-size:x-large">{{ same_score_records }}</b></p>
        {% endif %}
    {% else %}
        <p class="textBox">We think that you manipulated the URL!</p>
    {% endif %}

    {% if not existing_survey %}
      <form method="post" class="form">
          {% csrf_token %}
          <p>لطفا در نظرسنجی زیر شرکت کنید. ثبت امتیاز هم کافی‌ست.<br/> به نظر شما این Survey در خصوص <b>{{race.name}}</b> چه میزان مفید بود؟</p>
          <div>
            <label for="survey_score" style="align-self: flex-start;">از ۱ تا ۱۰ چند امتیاز می‌دهید؟</label>
            <select name="survey_score" id="survey_score" required>
                {% for n in num_list %}
                <option value="{{ n }}">{{ n }}</option>
                {% endfor %}
            </select>
          </div>
          <label for="text_box" style="align-self: flex-start; margin-top: 1rem">دیدگاه‌ها و پیشنهادهای خود را می‌توانید در باکس زیر بنویسید.</label>
          <textarea name="text_box" rows="4" cols="" id="surveyTextArea"></textarea>
          <button type="submit" class="btn realBtn">ثبت</button>
      </form>
    {% else %}
      <div class="form">
        <p class="textBox">شما قبلاً نظرسنجی این مسابقه را تکمیل کرده‌اید.</p>
        <p>امتیازی که به ما دادید: <b>{{ existing_survey.survey_score }}</b></p>
      {% if existing_survey.text_box %}
        <p style="align-self: flex-start;">متن شما:<br/> {{ existing_survey.text_box }}</p>
      {% endif %}
      </div>
    {% endif %}

    <a href="{% url 'step_race_detail' race.step_set.first.id %}" class="btn">مرور دوبارۀ پرسش‌ها</a>

    <script type="text/javascript">
      let textBox = document.querySelector('textarea[name="text_box"]');
      let selectBox = document.querySelector('select[name="survey_score"]');
      let hasStartedInteracting = false;

      // Detect tapping / clicking / changing the select element
      if (textBox) {
          ['focus', 'click', 'change', 'input'].forEach(eventType => {
              textBox.addEventListener(eventType, () => {
                  hasStartedInteracting = true;
              });
          });
      }

      if (selectBox) {
          ['focus', 'click', 'change', 'input'].forEach(eventType => {
              selectBox.addEventListener(eventType, () => {
                  hasStartedInteracting = true;
              });
          });
      }

      // Reload only if the user hasn't interacted
      setTimeout(() => {
          if (!hasStartedInteracting) {
              location.reload();
          }
      }, 10000);  // 10 seconds
  </script>

</body>
</html>
