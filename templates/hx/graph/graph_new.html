{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block title %}| Hx{%endblock title%}
{% block content %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<style>
    .preview{
        display: grid;
        grid-template-columns: 1fr 1fr;
    }
    @media(max-width:800px){
        .preview{
            grid-template-columns: 1fr;
            grid-template-rows: 1fr 1fr;
        }
    }

</style>
<div class="pad-15" dir="ltr">
    <h1>New Graph</h1>

    <form action="" method="post">{% csrf_token %}
    <div class="createForm" autocomplete="off">
        {{ form|crispy }}
    </div>
    <button class="btn btn-success ml-2" type="submit" id="save" >Submit</button>
    </form>

    <button class="btn btn-primary ml-2 mt-2" id="refresh-btn">Preview</button>

<div class="preview" dir="ltr">
    <div id="chart-container" style='display: none'>
        <canvas id="myChart" style="width: 400px; height: 200px;"></canvas>
    </div>
    <div id="table-container" style="display: none;">
        <table id="data-table">
            <thead>
                <tr>
                    <th>Label</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const beginAtZeroCheckbox = document.getElementById('id_zero');
const chartContainer = document.getElementById('chart-container');
const tableContainer = document.getElementById('table-container');
const canvas = document.getElementById('myChart');
const inputTextArea = document.getElementById('id_data');

function updateChart() {
    const inputData = inputTextArea.value.trim();
    if (inputData) {
        const lines = inputData.split('\n').filter(line => line.trim() !== '');
        const labels = [];
        const datasets = [];
        let maxDataPoints = 0;

        const tableBody = document.getElementById('data-table').querySelector('tbody');
        tableBody.innerHTML = ''; // Clear existing rows

        lines.forEach((line, index) => {
            const [label, values] = line.split(': ');
            const dataPoints = values.split(', ').map(val => val === '-' ? null : parseFloat(val.trim()));
            datasets.push({
                label: label.trim(),
                data: dataPoints,
                borderWidth: 2
            });

            // Add to table
            if (index === 0) {
                labels.push('');
                for (let i = 0; i < dataPoints.length; i++) {
                    labels.push((i + 1).toString());
                }
            }
            addToTable(label.trim(), dataPoints, tableBody);

            maxDataPoints = Math.max(maxDataPoints, dataPoints.length);
        });

        if (!maxDataPoints) return; // Exit if no data


        const beginAtZero = beginAtZeroCheckbox.checked;

        createChart(labels, datasets, beginAtZero);
    }
}

let myChart;

function createChart(labels, datasets, beginZero) {
    if (myChart) {
        myChart.destroy(); // Destroy previous chart instance
    }

    const ctx = canvas.getContext('2d');
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            scales: {
                y: {
                    beginAtZero: beginZero
                }
            }
        }
    });
}

function addToTable(label, dataPoints, tableBody) {
    const rowCount = tableBody.rows.length;

    if (rowCount === 0) {
        // Create header row
        const headerRow = tableBody.insertRow(-1);
        const labelHeader = headerRow.insertCell(0);
        labelHeader.textContent = 'Day:';
        for (let i = 0; i < dataPoints.length; i++) {
            const dataHeader = headerRow.insertCell(-1);
            dataHeader.textContent = 'D' + (i + 1).toString();
        }
    }

    // Insert label and data points
    const dataRow = tableBody.insertRow(-1);
    const labelCell = dataRow.insertCell(0);
    labelCell.textContent = label;
    for (let i = 0; i < dataPoints.length; i++) {
        const dataCell = dataRow.insertCell(-1);
        dataCell.textContent = dataPoints[i];
    }
}
function makeVis(){
    tableContainer.style.display='block'
    chartContainer.style.display='block'
}

const refreshButton = document.getElementById('refresh-btn');
refreshButton.addEventListener('click', makeVis);
refreshButton.addEventListener('click', updateChart);

beginAtZeroCheckbox.addEventListener('change', updateChart);
</script>

{% endblock content %}
